name: CI-cpp

on: [push, pull_request]

jobs:
  check:
    runs-on: ${{ matrix.config.os }}
    strategy:
      fail-fast: false
      matrix:
        config:
          - { os: windows-latest }
          - { os: macOS-latest }
          - { os: ubuntu-latest }

    steps:
      - uses: actions/checkout@v2


      - name: Install openssl MacOsX
        if: matrix.config.os == 'macOS-latest'
        run: brew install openssl
        BREW_PREFIX=`brew --prefix`
        export OPENSSL_ROOT_DIR=$BREW_PREFIX/opt/openssl
      - name: Install openssl Windows
        if: matrix.config.os == 'windows-latest'
        run: choco install openssl
      - name: Setup Python 3.6 for cpp_tests
        uses: actions/setup-python@v2
        with:
          python-version: 3.6
      - uses: lukka/get-cmake@latest
      - name: Run CMake
        uses: lukka/run-cmake@main
        id: runcmake
        with:
          cmakeGenerator: 'Ninja'
          cmakeListsOrSettingsJson: 'CMakeListsTxtBasic'
          cmakeListsTxtPath: '${{ github.workspace }}/tests/cpp/CMakeLists.txt'
          useVcpkgToolchainFile: true
          buildWithCMakeArgs: '-- -v'
          buildDirectory: '${{ runner.workspace }}/b/'
      - name: Run Cpp tests
        run: 'python3 ${{ github.workspace }}/tests/cpp/python/python_client_tests.py'
        working-directory: '${{ runner.workspace }}/b/'
